<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ Happy Tourist | AI Travel Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;900&display=swap');
        body { font-family: 'Montserrat', sans-serif; background: #0f172a; color: white; margin: 0; overflow-x: hidden; }
        .leaflet-control-attribution { display: none !important; }
        #map { height: 450px; width: 100%; border-radius: 24px; border: 4px solid #fff; z-index: 10; background: #1e293b; }
        .snow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        
        .cat-btn { transition: 0.3s; opacity: 0.4; cursor: pointer; border: 2px solid transparent; }
        .cat-btn.active { opacity: 1; border-color: white; transform: scale(1.05); }
        
        .btn-main { background: linear-gradient(45deg, #ef4444, #b91c1c); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }
        .map-label { color: white; padding: 4px 8px; border-radius: 8px; font-weight: 900; font-size: 9px; border: 2px solid white; background: rgba(0,0,0,0.8); white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-transform: uppercase; }
        
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ */
        #res-list::-webkit-scrollbar { width: 4px; }
        #res-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-6">

    <canvas class="snow" id="snowCanvas"></canvas>

    <div class="max-w-7xl mx-auto relative z-10">
        <header class="text-center mb-4">
            <h1 class="text-4xl font-black italic uppercase tracking-tighter text-white">
                <span class="text-red-500">HAPPY</span> TOURIST üéÅ
            </h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div class="glass-card p-5 rounded-[2rem] shadow-2xl border-t-4 border-red-500">
                    <div class="space-y-3">
                        <div class="relative">
                            <label class="text-[9px] font-black uppercase text-gray-400 ml-1">–°—Ç–∞—Ä—Ç:</label>
                            <input id="startInput" type="text" class="w-full p-3 bg-black/40 border border-white/10 rounded-xl outline-none focus:border-blue-500 text-sm" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ –∞–¥—Ä–µ—Å">
                            <button onclick="activateGPS()" class="absolute right-2 top-7 bg-blue-600 p-2 rounded-lg hover:bg-blue-400">üìç</button>
                        </div>
                        <div>
                            <label class="text-[9px] font-black uppercase text-gray-400 ml-1">–§–∏–Ω–∏—à (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                            <input id="endInput" type="text" class="w-full p-3 bg-black/40 border border-white/10 rounded-xl outline-none focus:border-red-500 text-sm" placeholder="–ö—É–¥–∞ –µ–¥–µ–º?">
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <button onclick="toggleCat('tourism', '–ì–ò–î', '#3b82f6', this)" class="cat-btn active p-2 rounded-lg text-[9px] font-black bg-blue-600 uppercase">üèõÔ∏è –î–æ—Å—Ç–æ–ø—Ä.</button>
                        <button onclick="toggleCat('museum', '–ú–£–ó–ï–ô', '#06b6d4', this)" class="cat-btn active p-2 rounded-lg text-[9px] font-black bg-cyan-600 uppercase">üé® –ú—É–∑–µ–π</button>
                        <button onclick="toggleCat('mall', '–®–û–ü', '#a855f7', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-purple-600 uppercase">üõçÔ∏è –®–æ–ø–∏–Ω–≥</button>
                        <button onclick="toggleCat('restaurant', '–ï–î–ê', '#ef4444', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-red-600 uppercase">üç± –ï–¥–∞</button>
                        <button onclick="toggleCat('hotel', '–û–¢–ï–õ–¨', '#f59e0b', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-orange-600 uppercase">üè® –û—Ç–µ–ª–∏</button>
                        <button onclick="toggleCat('park', '–ü–ê–†–ö', '#10b981', this)" class="cat-btn p-2 rounded-lg text-[9px] font-black bg-green-600 uppercase">üå≥ –ü–∞—Ä–∫–∏</button>
                    </div>

                    <button id="goBtn" onclick="buildRoute()" class="btn-main w-full mt-5 p-4 rounded-2xl font-black text-lg uppercase italic shadow-xl transition-all active:scale-95">
                        –ü–û–°–¢–†–û–ò–¢–¨ –¢–£–† üöÄ
                    </button>
                </div>

                <div id="list-card" class="glass-card p-5 rounded-[2rem] hidden overflow-hidden">
                    <h3 class="text-[10px] font-black uppercase text-red-500 mb-3 tracking-widest">–°–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫:</h3>
                    <div id="res-list" class="max-height-[150px] overflow-y-auto space-y-2 text-[11px] font-bold">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div id="map"></div>
                
                <div id="info-panel" class="glass-card p-5 rounded-[2rem] hidden flex justify-between items-center px-8 border-b-4 border-blue-500">
                    <div>
                        <p class="text-[9px] font-black text-gray-400 uppercase">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</p>
                        <p id="res-dist" class="text-2xl font-black text-white italic">---</p>
                    </div>
                    <div class="h-10 w-px bg-white/10"></div>
                    <div>
                        <p class="text-[9px] font-black text-gray-400 uppercase">–í—Ä–µ–º—è –≤ –ø—É—Ç–∏</p>
                        <p id="res-time" class="text-2xl font-black text-green-400 italic">---</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, routeLine, markers = [], userMarker;
        let selectedCats = [
            {type: 'tourism', label: '–ì–ò–î', color: '#3b82f6'},
            {type: 'museum', label: '–ú–£–ó–ï–ô', color: '#06b6d4'}
        ];

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([55.75, 37.61], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 500);
        }

        function activateGPS() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                map.setView([lat, lon], 14);
                document.getElementById('startInput').value = "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
            });
        }

        function toggleCat(type, label, color, btn) {
            const index = selectedCats.findIndex(c => c.type === type);
            if (index > -1) {
                selectedCats.splice(index, 1);
                btn.classList.remove('active');
            } else {
                selectedCats.push({ type, label, color });
                btn.classList.add('active');
            }
        }

        async function buildRoute() {
            const startName = document.getElementById('startInput').value;
            const endName = document.getElementById('endInput').value;
            if (!startName) return alert("–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ —Å—Ç–∞—Ä—Ç–∞!");

            const btn = document.getElementById('goBtn');
            const resList = document.getElementById('res-list');
            btn.innerText = "–ú–ê–ì–ò–Ø... ‚ú®";
            resList.innerHTML = "";

            markers.forEach(m => map.removeLayer(m));
            if (routeLine) map.removeLayer(routeLine);
            markers = [];

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(startName)}`);
                const data = await res.json();
                const start = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };

                let waypoints = [`${start.lon},${start.lat}`];

                for (let cat of selectedCats) {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${cat.type}&viewbox=${start.lon-0.05},${start.lat+0.05},${start.lon+0.05},${start.lat-0.05}&bounded=1&limit=3`;
                    const poiRes = await fetch(url);
                    const poiData = await poiRes.json();
                    
                    poiData.forEach(p => {
                        const name = p.display_name.split(',')[0];
                        waypoints.push(`${p.lon},${p.lat}`);
                        
                        const icon = L.divIcon({
                            className: 'label',
                            html: `<div class="map-label" style="border-color:${cat.color}">${cat.label}: ${name}</div>`
                        });
                        markers.push(L.marker([p.lat, p.lon], {icon: icon}).addTo(map));
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫
                        resList.innerHTML += `<div class="flex items-center gap-2"><span style="color:${cat.color}">‚óè</span> ${name}</div>`;
                    });
                }

                if (endName) {
                    const endRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endName)}`);
                    const endData = await endRes.json();
                    if (endData.length) waypoints.push(`${endData[0].lon},${endData[0].lat}`);
                }

                const osrm = `https://router.project-osrm.org/route/v1/driving/${waypoints.join(';')}?overview=full&geometries=geojson`;
                const rRes = await fetch(osrm);
                const rData = await rRes.json();

                if (rData.routes) {
                    const route = rData.routes[0];
                    routeLine = L.polyline(route.geometry.coordinates.map(c => [c[1], c[0]]), {color: '#ef4444', weight: 5, opacity: 0.8}).addTo(map);
                    map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ
                    document.getElementById('info-panel').classList.remove('hidden');
                    document.getElementById('list-card').classList.remove('hidden');
                    document.getElementById('res-dist').innerText = (route.distance / 1000).toFixed(1) + " –∫–º";
                    document.getElementById('res-time').innerText = Math.round(route.duration / 60) + " –º–∏–Ω";
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.");
            }
            btn.innerText = "–ü–û–ï–•–ê–õ–ò! üöÄ";
        }

        function initSnow() {
            const canvas = document.getElementById('snowCanvas');
            const ctx = canvas.getContext('2d');
            let w = canvas.width = window.innerWidth, h = canvas.height = window.innerHeight;
            const flakes = Array.from({length: 40}, () => ({x: Math.random()*w, y: Math.random()*h, r: Math.random()*3+1, d: Math.random()*0.5+0.2}));
            function draw() {
                ctx.clearRect(0,0,w,h); ctx.fillStyle = "white"; ctx.beginPath();
                flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); }); ctx.fill();
                flakes.forEach(f => { f.y += f.d; if(f.y > h) f.y = -10; });
                requestAnimationFrame(draw);
            }
            draw();
        }

        window.onload = () => { initMap(); initSnow(); };
    </script>
</body>
</html>